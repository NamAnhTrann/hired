<section class="max-w-5xl mt-32 mx-auto px-4 py-10">
  @if (product) {
    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">

      <!-- PRODUCT IMAGE -->
      <div class="w-full">
        <img
          [src]="product.product_image[0]"
          [alt]="product.product_title"
          class="w-full rounded-xl object-cover"
        />
      </div>

      <!-- PRODUCT INFO -->
      <div class="flex flex-col">

        <!-- TITLE -->
        <h1 class="text-3xl font-semibold mb-4">
          {{ product.product_title }}
        </h1>

        <!-- DESCRIPTION -->
        <p class="text-gray-600 mb-6 leading-relaxed">
          {{ product.product_description }}
        </p>

        <!-- PRICE -->
        <h2 class="text-2xl font-bold mb-6">
          ${{ product.product_price }}
        </h2>

        <!-- SOCIAL ACTIONS -->
        <div class="flex items-center gap-6 mb-6">

          <!-- LIKE BUTTON -->
          <button
            (click)="toggleLikeProduct(product)"
            class="flex items-center gap-2 text-indigo-700 hover:text-indigo-500 font-semibold"
          >
            <span>
              @if (product.liked_by_user) { â™¥ } @else { â™¡ }
            </span>
            <span>{{ product.like_count }}</span>
          </button>

          <!-- COMMENT BUTTON -->
          <button
            (click)="toggleComments(product._id)"
            class="flex items-center gap-2 text-gray-700 hover:text-gray-500"
          >
            ðŸ’¬ <span>{{ product.comment_count }}</span>
          </button>

        </div>

        <!-- QUANTITY + ADD TO CART -->
        <div class="flex items-center gap-4 mb-8">
          <input
            type="number"
            [value]="quantity"
            (input)="setQuantity($event)"
            min="1"
            class="w-20 border border-gray-300 rounded-lg py-2 px-3 text-center"
          />

          <button
            (click)="add_cart(product._id, quantity)"
            class="px-6 py-3 bg-indigo-700 text-white text-sm font-semibold rounded-lg hover:bg-indigo-600 transition"
          >
            Add To Cart
          </button>
        </div>

      </div>
    </div>

    <!-- COMMENTS SECTION -->
    @if (activeProduct === product._id) {
      <div class="mt-12 border-t pt-8">

        <!-- NEW COMMENT BOX -->
        <textarea
          [(ngModel)]="newComment[product._id]"
          placeholder="Write a comment..."
          class="w-full border rounded-lg p-3 mb-4"
        ></textarea>

        <button
          (click)="postComment(product._id)"
          class="px-4 py-2 bg-indigo-700 text-white rounded-lg hover:bg-indigo-600"
        >
          Post Comment
        </button>

        <!-- LIST COMMENTS -->
        <div class="mt-8 space-y-4">

          @for (c of comments[product._id]; track c._id) {
            <div class="border p-4 rounded-lg bg-gray-50">

              <p class="font-semibold">{{ c.user.username }}</p>
              <p class="text-gray-700 mb-3">{{ c.text }}</p>



              <!-- REPLY -->
              <button
                (click)="toggleReply(product._id, c._id)"
                class="ml-4 text-sm text-gray-700 hover:text-gray-500"
              >
                Reply
              </button>

              <!-- DELETE -->
              <button
                (click)="deleteComment(c, product, true)"
                class="ml-4 text-sm text-red-600 hover:text-red-500"
              >
                Delete
              </button>

              <!-- REPLY BOX -->
              @if (replyBox[product._id]?.[c._id]) {
                <div class="mt-3 ml-6">
                  <textarea
                    [(ngModel)]="replyText[c._id]"
                    placeholder="Write reply..."
                    class="w-full border rounded-lg p-2"
                  ></textarea>

                  <button
                    (click)="postReply(product._id, c._id)"
                    class="mt-2 px-3 py-1 bg-indigo-700 text-white rounded-md"
                  >
                    Reply
                  </button>
                </div>
              }

              <!-- CHILD REPLIES -->
              @for (r of c.replies; track r._id) {
                <div class="ml-6 mt-4 border-l pl-4">

                  <p class="font-semibold">{{ r.user.username }}</p>
                  <p class="text-gray-700 mb-2">{{ r.text }}</p>

    

                  <button
                    (click)="deleteComment(r, product, false)"
                    class="ml-4 text-sm text-red-600 hover:text-red-500"
                  >
                    Delete
                  </button>

                </div>
              }

            </div>
          }

        </div>
      </div>
    }

  }

  @else {
    <div class="text-center py-20">
      <p class="text-lg text-gray-500">Loading product...</p>
    </div>
  }
</section>
